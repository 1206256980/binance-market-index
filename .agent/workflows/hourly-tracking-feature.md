# 逐小时盈亏追踪功能说明

> **用途**：当需要向AI解释此功能时，可以直接提供此文档作为上下文。

## 功能概述

"逐小时盈亏追踪"是一个**回顾性分析**功能。核心设计是采用**基准点(Pivot)模式**：用户点击的入场时间是盈亏曲线的**0轴/中心点**，该时刻盈亏为0。

## 核心设计：Pivot基准点模式

### 基准点的作用

当用户点击某一行（如20:00）的"追踪"按钮时：
1. **确定做空币种**：获取该时刻的涨幅榜 Top N
2. **确定基准价格**：使用该时刻的开盘价作为基准
3. **该时刻盈亏为0**：作为整个盈亏曲线的中心点

### 盈亏计算逻辑

以 **20:00 作为基准点** 为例：

| 快照时间 | 入场价 | 平仓价 | 盈亏计算公式 |
|----------|--------|--------|--------------|
| 18:00（基准点**之前**） | 18:00价格 | 20:00价格 | (18:00价 - 20:00价) / 18:00价 |
| 19:00（基准点**之前**） | 19:00价格 | 20:00价格 | (19:00价 - 20:00价) / 19:00价 |
| **20:00（基准点）** | - | - | **= 0** |
| 21:00（基准点**之后**） | 20:00价格 | 21:00价格 | (20:00价 - 21:00价) / 20:00价 |
| 22:00（基准点**之后**） | 20:00价格 | 22:00价格 | (20:00价 - 22:00价) / 20:00价 |

### 追踪范围

- **向前**：基准点 - monitorHours 小时
- **向后**：到当前时间 + 最新5分钟K线

## 使用场景举例

假设当前时间是 **2026年2月4日 20:27**，用户设置 **monitorHours=24**：

| 操作 | 结果 |
|------|------|
| 用户点击"20:00"入场行的追踪按钮 | 获取20:00涨幅榜Top N作为做空标的 |
| 基准价格 | 使用20:00的开盘价 |
| 追踪范围 | 2月3日 20:00 → 2月4日 20:27(最新) |
| **20:00盈亏** | **= 0（基准点）** |
| 19:00盈亏 | = 如果19:00入场，20:00平仓的盈亏 |
| 21:00盈亏 | = 如果20:00入场，21:00平仓的盈亏 |

## 设计意义

这个设计让用户可以直观看到：
1. **基准点之前**（左侧曲线）：如果更早入场，到基准点平仓，盈亏如何？
2. **基准点之后**（右侧曲线）：如果在基准点入场，随时间推移的盈亏变化

## 相关代码位置

| 组件 | 文件路径 | 关键方法/函数 |
|------|----------|--------------|
| 后端服务 | `IndexCalculatorService.java` | `getHourlyTracking()`, `calculatePivotSnapshotProfit()` |
| 后端接口 | `IndexController.java` | `GET /api/index/live-monitor/hourly-tracking` |
| 前端组件 | `LiveMonitorModule.jsx` | `handleTrackingClick()` |

## API参数说明

| 参数 | 类型 | 作用 |
|------|------|------|
| `entryTime` | String | 基准点时间（盈亏=0的中心点） |
| `rankingHours` | int | 涨幅榜周期（如24表示24小时涨幅榜） |
| `topN` | int | 做空涨幅榜前N名 |
| `totalAmount` | double | 总投入金额 |
| `monitorHours` | int | 向前追踪多少小时 |
| `timezone` | String | 用户时区 |

## 返回数据结构

```json
{
  "entryTime": "2026-02-04 20:00",
  "pivotTime": "2026-02-04 20:00",
  "trackingStart": "2026-02-03 20:00",
  "trackingEnd": "2026-02-04 20:00",
  "entryCoins": [
    {"symbol": "BTCUSDT", "pivotPrice": 50000.0, "change24h": 5.2}
  ],
  "hourlySnapshots": [
    {
      "snapshotTime": "2026-02-03 20:00",
      "hoursFromPivot": -24,
      "isPivot": false,
      "isLatest": false,
      "totalProfit": 12.50
    },
    {
      "snapshotTime": "2026-02-04 20:00",
      "hoursFromPivot": 0,
      "isPivot": true,
      "isLatest": false,
      "totalProfit": 0.00
    }
  ]
}
```

## 向AI说明时的推荐表述

> 这个功能叫"逐小时盈亏追踪"，采用**基准点(Pivot)模式**。
> 
> 核心概念：
> - 用户点击的入场时间是**基准点**，该时刻盈亏 = 0
> - **基准点之前**的快照：以该快照价格为入场价，基准点价格为平仓价
> - **基准点之后**的快照：以基准点价格为入场价，该快照价格为平仓价
> 
> 这样设计可以看到：如果更早入场会赚多少（左侧），入场后随时间变化赚/亏多少（右侧）。
