# 逐小时盈亏追踪功能说明

> **用途**：当需要向AI解释此功能时，可以直接提供此文档作为上下文。

## 功能概述

"逐小时盈亏追踪"是一个**回顾性分析**功能，用于分析：如果使用某个时间点的入场条件（涨幅榜Top N），在过去若干小时的市场行情下，做空策略的表现如何。

## 核心设计：入场条件与追踪范围解耦

这个功能最重要的设计是：**入场条件** 和 **追踪范围** 是完全分开的两个概念。

### 入场条件（由 entryTime 决定）

当用户点击某一行的"追踪"按钮时，该行的时间（如15:00）仅用于：
1. **确定做空哪些币种**：获取该时刻的涨幅榜 Top N
2. **确定入场价格**：使用该时刻的开盘价作为固定基准价

### 追踪范围（由 monitorHours 和当前时间决定）

追踪范围与入场时间**完全无关**：
- **开始时间** = 当前整点 - monitorHours
- **结束时间** = 当前整点 + 最新5分钟K线（标记为"实时"）

### 盈亏计算

每个快照时间点的盈亏计算方式：
```
盈亏 = (入场价 - 该时刻历史价格) / 入场价 × 投入金额
```
入场价在整个追踪过程中**保持固定不变**。

## 使用场景举例

假设当前时间是 **2026年2月4日 20:05**，用户设置 **monitorHours=24**：

| 操作 | 结果 |
|------|------|
| 用户点击"15:00"入场行的追踪按钮 | 获取15:00涨幅榜Top N作为做空标的 |
| 入场价格 | 使用15:00的开盘价（固定） |
| 追踪范围 | 2月3日 20:00 → 2月4日 20:00 + 最新价格 |
| 快照数量 | 24个整点快照 + 1个实时快照 |
| 盈亏基准 | 所有快照的盈亏都相对于15:00入场价计算 |

如果用户改点"18:00"入场行：
- 入场条件变为18:00的涨幅榜和价格
- 但追踪范围**仍然是** 2月3日 20:00 → 2月4日 20:00

## 设计意义

这个设计允许用户：
1. **对比不同入场时间点**：如果当时入场，在相同的历史行情下表现如何
2. **立即看到完整追踪曲线**：不需要等待未来数据
3. **评估回撤和盈利情况**：某个特定涨幅榜组合在历史行情下的表现

## 相关代码位置

| 组件 | 文件路径 | 关键方法/函数 |
|------|----------|--------------|
| 后端服务 | `IndexCalculatorService.java` | `getHourlyTracking()` |
| 后端接口 | `IndexController.java` | `GET /api/index/live-monitor/hourly-tracking` |
| 前端组件 | `LiveMonitorModule.jsx` | `handleTrackingClick()` |

## API参数说明

| 参数 | 类型 | 作用 |
|------|------|------|
| `entryTime` | String | 入场时间，用于确定做空币种和入场价格 |
| `rankingHours` | int | 涨幅榜周期（如24表示24小时涨幅榜） |
| `topN` | int | 做空涨幅榜前N名 |
| `totalAmount` | double | 总投入金额 |
| `monitorHours` | int | 追踪范围长度（决定看过去多少小时） |
| `timezone` | String | 用户时区 |

## 返回数据结构

```json
{
  "entryTime": "2026-02-04 15:00",
  "trackingStart": "2026-02-03 20:00",
  "trackingEnd": "2026-02-04 20:00",
  "entryCoins": [
    {"symbol": "BTCUSDT", "entryPrice": 50000.0, "change24h": 5.2}
  ],
  "hourlySnapshots": [
    {
      "snapshotTime": "2026-02-03 20:00",
      "hoursFromStart": 0,
      "isLatest": false,
      "totalProfit": 12.50,
      "winCount": 3,
      "loseCount": 2,
      "trades": [...]
    }
  ]
}
```

## 向AI说明时的推荐表述

> 这个功能叫"逐小时盈亏追踪"。核心概念是入场条件和追踪范围是解耦的。
> 
> - `entryTime` 只用于确定做空哪些币和入场价格
> - 追踪范围由 `monitorHours` 和当前时间决定，与 `entryTime` 无关
> - 所有快照的盈亏都相对于入场价格计算
> 
> 这样设计是为了让用户可以选择不同的入场条件，对比它们在相同历史行情下的表现。
