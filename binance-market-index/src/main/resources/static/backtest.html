<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšç©ºæ¶¨å¹…æ¦œå‰10å›æµ‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f1f5f9;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 16px;
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .params-form {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
        }

        .param-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .param-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .param-group input {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            width: 120px;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .param-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .time-inputs input {
            width: 70px;
            text-align: center;
        }

        .time-inputs span {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .btn-primary {
            padding: 12px 28px;
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-msg {
            padding: 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
            color: var(--danger);
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç»“æœåŒºåŸŸ */
        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .summary-card.highlight {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .summary-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-value.large {
            font-size: 1.8rem;
        }

        .positive { color: var(--success) !important; }
        .negative { color: var(--danger) !important; }

        .skipped-days {
            padding: 12px 16px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-sm);
            color: var(--warning);
            font-size: 0.85rem;
            margin-bottom: 20px;
        }

        /* æ¯æ—¥æ˜ç»† */
        .daily-list {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .daily-header {
            padding: 14px 16px;
            background: var(--bg-primary);
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .daily-item {
            border-bottom: 1px solid var(--border-color);
        }

        .daily-item:last-child {
            border-bottom: none;
        }

        .daily-summary {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            gap: 16px;
        }

        .daily-summary:hover {
            background: var(--bg-card-hover);
        }

        .daily-summary.expanded {
            background: var(--bg-card-hover);
            border-bottom: 1px solid var(--border-color);
        }

        .daily-date {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 100px;
        }

        .daily-stats {
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex: 1;
        }

        .daily-profit {
            font-weight: 700;
            min-width: 100px;
            text-align: right;
        }

        .expand-icon {
            color: var(--text-muted);
            font-size: 0.8rem;
            width: 20px;
        }

        /* äº¤æ˜“æ˜ç»†è¡¨æ ¼ */
        .trades-table {
            width: 100%;
            background: var(--bg-primary);
            padding: 16px;
            display: none;
        }

        .trades-table.show {
            display: block;
        }

        .trades-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .trades-table th,
        .trades-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px dashed var(--border-color);
        }

        .trades-table th {
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .trades-table tr:last-child td {
            border-bottom: none;
        }

        .symbol-cell {
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .params-form {
                flex-direction: column;
                align-items: stretch;
            }

            .param-group input {
                width: 100%;
            }

            .result-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            .trades-table {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
        
        <div class="header">
            <h1>ğŸ“Š åšç©ºæ¶¨å¹…æ¦œå‰10å›æµ‹</h1>
            <p>æ¯å¤©å›ºå®šæ—¶é—´åšç©º24å°æ—¶æ¶¨å¹…å‰10çš„å¸ç§ï¼Œ24å°æ—¶åå¹³ä»“ï¼ŒéªŒè¯ç­–ç•¥èƒœç‡å’Œæ”¶ç›Š</p>
        </div>

        <div class="card">
            <div class="params-form">
                <div class="param-group">
                    <label>å…¥åœºæ—¶é—´</label>
                    <div class="time-inputs">
                        <input type="number" id="entryHour" min="0" max="23" value="12">
                        <span>:</span>
                        <input type="number" id="entryMinute" min="0" max="59" value="0">
                    </div>
                </div>

                <div class="param-group">
                    <label>æ¯å¸é‡‘é¢ (USDT)</label>
                    <input type="number" id="amountPerCoin" min="1" value="100">
                </div>

                <div class="param-group">
                    <label>å›æµ‹å¤©æ•°</label>
                    <input type="number" id="days" min="1" max="365" value="30">
                </div>

                <button class="btn-primary" id="runBtn" onclick="runBacktest()">
                    ğŸš€ å¼€å§‹å›æµ‹
                </button>
            </div>

            <div id="errorArea" class="error-msg" style="display:none;"></div>
            <div id="loadingArea" class="loading" style="display:none;">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨å›æµ‹ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
            <div id="resultArea" style="display:none;"></div>
        </div>
    </div>

    <script>
        async function runBacktest() {
            const entryHour = parseInt(document.getElementById('entryHour').value) || 12
            const entryMinute = parseInt(document.getElementById('entryMinute').value) || 0
            const amountPerCoin = parseFloat(document.getElementById('amountPerCoin').value) || 100
            const days = parseInt(document.getElementById('days').value) || 30

            const btn = document.getElementById('runBtn')
            const errorArea = document.getElementById('errorArea')
            const loadingArea = document.getElementById('loadingArea')
            const resultArea = document.getElementById('resultArea')

            // éšè—ä¹‹å‰çš„ç»“æœ
            errorArea.style.display = 'none'
            resultArea.style.display = 'none'
            loadingArea.style.display = 'block'
            btn.disabled = true
            btn.textContent = 'ğŸ”„ å›æµ‹ä¸­...'

            try {
                const params = new URLSearchParams({
                    entryHour,
                    entryMinute,
                    amountPerCoin,
                    days,
                    timezone: 'Asia/Shanghai'
                })

                const response = await fetch(`/api/index/backtest/short-top10?${params}`)
                const data = await response.json()

                if (data.success) {
                    renderResult(data)
                    resultArea.style.display = 'block'
                } else {
                    errorArea.innerHTML = 'âš ï¸ ' + (data.message || 'å›æµ‹å¤±è´¥')
                    errorArea.style.display = 'block'
                }
            } catch (err) {
                console.error('å›æµ‹è¯·æ±‚å¤±è´¥:', err)
                errorArea.innerHTML = 'âš ï¸ è¯·æ±‚å¤±è´¥: ' + err.message
                errorArea.style.display = 'block'
            } finally {
                loadingArea.style.display = 'none'
                btn.disabled = false
                btn.textContent = 'ğŸš€ å¼€å§‹å›æµ‹'
            }
        }

        function formatProfit(value) {
            if (value === null || value === undefined) return '--'
            const prefix = value >= 0 ? '+' : ''
            return prefix + value.toFixed(2)
        }

        function getProfitClass(value) {
            if (value === null || value === undefined) return ''
            return value >= 0 ? 'positive' : 'negative'
        }

        function renderResult(data) {
            const summary = data.summary
            const dailyResults = data.dailyResults || []
            const skippedDays = data.skippedDays || []

            let html = `
                <div class="result-summary">
                    <div class="summary-card">
                        <div class="summary-label">ğŸ“… æœ‰æ•ˆå¤©æ•°</div>
                        <div class="summary-value">${summary.validDays} / ${summary.totalDays}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ğŸ“ˆ æ€»äº¤æ˜“</div>
                        <div class="summary-value">${summary.totalTrades} ç¬”</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ğŸ¯ èƒœç‡</div>
                        <div class="summary-value ${summary.winRate >= 50 ? 'positive' : 'negative'}">${summary.winRate}%</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">âœ… ç›ˆåˆ©ç¬”æ•°</div>
                        <div class="summary-value positive">${summary.winTrades}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">âŒ äºæŸç¬”æ•°</div>
                        <div class="summary-value negative">${summary.loseTrades}</div>
                    </div>
                    <div class="summary-card highlight">
                        <div class="summary-label">ğŸ’° æ€»ç›ˆäº</div>
                        <div class="summary-value large ${getProfitClass(summary.totalProfit)}">${formatProfit(summary.totalProfit)} U</div>
                    </div>
                </div>
            `

            if (skippedDays.length > 0) {
                html += `<div class="skipped-days">âš ï¸ ä»¥ä¸‹æ—¥æœŸå› æ•°æ®ç¼ºå¤±è¢«è·³è¿‡: ${skippedDays.join(', ')}</div>`
            }

            html += `<div class="daily-list">
                <div class="daily-header">ğŸ“‹ æ¯æ—¥æ˜ç»†ï¼ˆç‚¹å‡»å±•å¼€æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…ï¼‰</div>`

            dailyResults.forEach((day, idx) => {
                const tradesHtml = day.trades.map(trade => `
                    <tr>
                        <td class="symbol-cell">${trade.symbol.replace('USDT', '')}</td>
                        <td class="positive">+${trade.change24h?.toFixed(2)}%</td>
                        <td>${trade.entryPrice?.toFixed(4)}</td>
                        <td>${trade.exitPrice?.toFixed(4)}</td>
                        <td class="${getProfitClass(trade.profitPercent)}">${formatProfit(trade.profitPercent)}%</td>
                        <td class="${getProfitClass(trade.profit)}">${formatProfit(trade.profit)} U</td>
                    </tr>
                `).join('')

                html += `
                    <div class="daily-item">
                        <div class="daily-summary" onclick="toggleTrades(${idx})">
                            <span class="daily-date">${day.date}</span>
                            <span class="daily-stats">
                                ç›ˆåˆ© <strong class="positive">${day.winCount}</strong> / 
                                äºæŸ <strong class="negative">${day.loseCount}</strong>
                            </span>
                            <span class="daily-profit ${getProfitClass(day.totalProfit)}">${formatProfit(day.totalProfit)} U</span>
                            <span class="expand-icon" id="icon-${idx}">â–¶</span>
                        </div>
                        <div class="trades-table" id="trades-${idx}">
                            <table>
                                <thead>
                                    <tr>
                                        <th>å¸ç§</th>
                                        <th>å…¥åœºæ¶¨å¹…</th>
                                        <th>å¼€ä»“ä»·</th>
                                        <th>å¹³ä»“ä»·</th>
                                        <th>ç›ˆäº%</th>
                                        <th>ç›ˆäºU</th>
                                    </tr>
                                </thead>
                                <tbody>${tradesHtml}</tbody>
                            </table>
                        </div>
                    </div>
                `
            })

            html += '</div>'

            document.getElementById('resultArea').innerHTML = html
        }

        function toggleTrades(idx) {
            const tradesDiv = document.getElementById(`trades-${idx}`)
            const icon = document.getElementById(`icon-${idx}`)
            const summary = tradesDiv.previousElementSibling

            if (tradesDiv.classList.contains('show')) {
                tradesDiv.classList.remove('show')
                icon.textContent = 'â–¶'
                summary.classList.remove('expanded')
            } else {
                tradesDiv.classList.add('show')
                icon.textContent = 'â–¼'
                summary.classList.add('expanded')
            }
        }
    </script>
</body>
</html>
